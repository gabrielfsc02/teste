import{W as u,R as b,a as g,c as W,j as h,r as z,I as v,U as x}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed10.js";import{c as l,u as y}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed19.js";import{X as L,y as U,c as _,$ as j,a0 as N,a1 as B,a2 as P,a3 as F,n as w,W as O}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed22.js";import{W as k}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed18.js";import{c as $}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed7.js";async function T(e){const{getQuickReply:o}=L.getState(),{sendAction:a}=U.getState();if(e.respostaRapida!==null&&e.respostaRapida.length!==0){const n=o(e.respostaRapida);n?(await a(n,e.userID,{desativar:!1,personalizar:!1,nome:""}),_.getState().dispartWebhook(e.userID.replace(/@c\.us/g,""),"agendamento",{type:e.tipo,name:e.titulo,recorrencia:e.recorrencia})):console.error(`Resposta rapida do ID ${e.respostaRapida} não foi localizada`);return}const s={desativar:!1,personalizar:!1,nome:""};switch(e.tipo){case"txt":N(e.userID,{mensagem:e.mensagem,composing:1,aguarde:0},s);break;case"image":F(e.userID,{base64:e.base64,mensagem:e.mensagem,composing:1,aguarde:0,isViewOnce:!1},s);break;case"video":P(e.userID,{base64:e.base64,mensagem:e.mensagem,composing:1,aguarde:0,isViewOnce:!1,microVideo:!1},s);break;case"audio":await B(e.userID,{base64:e.base64,composing:1}),e.mensagem.length>0&&N(e.userID,{mensagem:e.mensagem,composing:1,aguarde:0},s);break;case"doc":await j(e.userID,{base64:e.base64,base64Name:e.base64Name}),e.mensagem.length>0&&N(e.userID,{mensagem:e.mensagem,composing:1,aguarde:0},s);break}_.getState().dispartWebhook(e.userID.replace(/@c\.us/g,""),"agendamento",{type:e.tipo,name:e.titulo,recorrencia:e.recorrencia})}function V(e,o){const a=new Date(e.data+"T"+e.hora),n=Math.floor((new Date().getTime()-a.getTime())/6e4),i=n<0;if(o){if(!i)return n<=5&&n>=0}else if(!i)return n>=0}const d=$((e,o)=>({agendamentos:[],agendamentosNaoDisparados:[],sendAfterWhatsAppOpens:!1,buttonActive:!1,loadStates:!1,setButtonActive:a=>{o().buttonActive!==a&&(l.getState().plugin_page?u("set-active-button",a,!1):chrome.runtime.sendMessage({action:"set-active-button",dados:a}),e({buttonActive:a}))},setSendAfterWhatsAppOpens:a=>{o().sendAfterWhatsAppOpens===a||a===void 0||a===null||(g("sendAfterWhatsAppOpens",a),l.getState().plugin_page?u("update-send-whats-open",{value:a},!1):chrome.runtime.sendMessage({action:"update-send-whats-open",dados:{value:a}}),e({sendAfterWhatsAppOpens:a}))},addAgendamento:a=>e(s=>{const n=[...s.agendamentos,a];return g("agendamentos",n),l.getState().plugin_page?u("addAgendamento",a,!1):chrome.runtime.sendMessage({action:"addAgendamento",dados:a}),{agendamentos:n}}),iniciarEnvio:async()=>{const{agendamentos:a,loadStates:s}=d.getState();if(!await k.Webpack("isFullReady")||!s)return;const c=a.map(t=>{var D;const p=V(t,o().sendAfterWhatsAppOpens),S=((D=t.recorrencia)==null?void 0:D.length)>0||t.recorrenciaManual;return p===void 0?null:p?{...t,status:"enviado"}:{...t,status:S?"recorrente":"não enviado",notsend:!0}}).filter(t=>t!==null);if(c.length===0)return;const r=c.filter(t=>t.status==="não enviado"||t.status==="enviado"||t.status==="recorrente");if(r.length!==0){let p=o().agendamentosNaoDisparados;p.length>=30?p=[...p.slice(1),...r.slice(-30)]:p=[...p,...r.slice(0,30-p.length)];const S=c.filter(A=>A.status==="recorrente").map(A=>({...A,status:"enviado"}));e({agendamentosNaoDisparados:p}),g("agendamentosNaoDisparados",p);const M=[...o().agendamentos.filter(A=>!r.some(C=>C.id===A.id)),...S];e({agendamentos:M}),g("agendamentos",M)}const m=c.filter(t=>t.status==="enviado"||(t==null?void 0:t.notsend));if(m.length===0)return;const f=[],R=[];for(const t of m)!(t!=null&&t.notsend)&&T(t),R.push(t.id),t.recorrencia&&t.recorrencia.length!==0&&(t.recorrenciaManual?t.data=x.CalcularProximaDataDias(t.data,t.recorrencia):t.data=x.CalcularProximaData(t.data,t.recorrencia),f.push(t));const I=[...a.filter(t=>!R.includes(t.id)),...f],E=m.map(t=>({id:t.id,data:t.data,recorrencia:t.recorrencia}));chrome.runtime.sendMessage({action:"agendamento-dispart",dados:E}),g("agendamentos",I),e({agendamentos:I})},enviarAgendamento:a=>{const s=y.getState().language;W({icon:h.jsx(O,{className:"text-[var(--primaria)]",size:22}),content:h.jsxs(h.Fragment,{children:[s.agenSendSucess,h.jsx("strong",{children:a.titulo}),s.agora,"?"]}),confirmText:s.confirm,submit:()=>{n()}});const n=()=>{T(a),v({type:"Success",message:`${s.oAgendamento} ${a.titulo} ${s.sendSucess}.`,position:"top-right"});const i=o().agendamentosNaoDisparados.map(c=>c.id===a.id?{...c,status:"enviado"}:c);l.getState().plugin_page?u("send-agendamento",i,!1):chrome.runtime.sendMessage({action:"send-agendamento",dados:i}),g("agendamentosNaoDisparados",i),e({agendamentosNaoDisparados:i})}},editAgendamento:(a,s)=>e(n=>{let i,c=n.agendamentosNaoDisparados;s==="agendamento"?(i=n.agendamentos.map(m=>m.id===a.id?{...a}:m),g("agendamentos",i)):s==="relatorio"&&(c=n.agendamentosNaoDisparados.filter(m=>m.id!==a.id),i=[...n.agendamentos,{...a,status:"enviado",id:z()}],g("agendamentosNaoDisparados",c),g("agendamentos",i));const r={editedAgen:a,type:s};return l.getState().plugin_page?u("editAgendamento",r,!0):chrome.runtime.sendMessage({action:"editAgendamento",dados:r}),{agendamentos:i,agendamentosNaoDisparados:c??n.agendamentosNaoDisparados}}),removeAgendamento:(a,s)=>{const n=y.getState().language,i=()=>{if(s==="agendamento"){const r=o().agendamentos.filter(m=>m.id!==a);g("agendamentos",r),e({agendamentos:r}),v({type:"Success",message:n.agendamento_Notif_rm,position:"top-right"})}else if(s==="relatorio"){const r=o().agendamentosNaoDisparados.filter(m=>m.id!==a);g("agendamentosNaoDisparados",r),e({agendamentosNaoDisparados:r}),v({type:"Success",message:n.rel_notify_rm,position:"top-right"})}const c={id:a,type:s};l.getState().plugin_page?u("agendamento-remove",c,!1):chrome.runtime.sendMessage({action:"agendamento-remove",dados:c})};W({icon:h.jsx(O,{className:"text-[var(--primaria)]",size:22}),content:n.agenRemoveConfirm,confirmText:n.confirm,submit:()=>i()})},openUserChat:a=>{a&&(k.Chat("openChatBottom",a),w.getState().close(),l.getState().plugin_page?u("openUserChat",a,!1):chrome.runtime.sendMessage({action:"openUserChat",dados:a}))}})),X=async()=>{l.getState().plugin_page&&u("get-send-whats-open",{},!0);const e=await b("agendamentos")||[],o=await b("agendamentosNaoDisparados")||[],a=await b("sendAfterWhatsAppOpens")||!1;d.setState({agendamentos:e,agendamentosNaoDisparados:o,sendAfterWhatsAppOpens:a,loadStates:!0}),d.getState().iniciarEnvio()};chrome.runtime.onMessage.addListener(async e=>{switch(e.action){case"Update_Agendamento":l.getState().plugin_page||d.getState().iniciarEnvio();break;case"agendamentos-backup-update":X();break;case"agendamento-remove":if(e.dados.type==="agendamento"){const a=d.getState().agendamentos.filter(s=>s.id!==e.dados.id);d.setState({agendamentos:a})}else if(e.dados.type==="relatorio"){const a=d.getState().agendamentosNaoDisparados.filter(s=>s.id!==e.dados.id);d.setState({agendamentosNaoDisparados:a})}break;case"addAgendamento":d.setState({agendamentos:[...d.getState().agendamentos,e.dados]});break;case"editAgendamento":if(e.dados.type==="agendamento"){const a=d.getState().agendamentos.map(s=>s.id===e.dados.editedAgen.id?{...e.dados.editedAgen}:s);d.setState({agendamentos:a})}else if(e.dados.type==="relatorio"){const a=d.getState().agendamentosNaoDisparados.filter(i=>i.id!==e.dados.editedAgen.id),n=[...d.getState().agendamentos,{...e.dados.editedAgen,status:"enviado"}];d.setState({agendamentos:n,agendamentosNaoDisparados:a})}break;case"agendamento-dispart":let o=d.getState().agendamentos;e.dados.map(a=>{a.recorrencia.length==0?o=o.filter(s=>s.id!==a.id):o=o.map(s=>(s.id===a.id&&(s.data=a.data,s.recorrencia=a.recorrencia),s))}),d.setState({agendamentos:o});break;case"update-send-whats-open":e.dados.value!==void 0&&d.getState().setSendAfterWhatsAppOpens(e.dados.value);break;case"get-send-whats-open":chrome.runtime.sendMessage({action:"update-send-whats-open",dados:{value:d.getState().sendAfterWhatsAppOpens}});break;case"set-active-button":d.getState().setButtonActive(e.dados);break;case"send-agendamento":d.setState({agendamentosNaoDisparados:e.dados});break;case"openUserChat":k.Chat("openChatBottom",e.dados),w.getState().close();break}});const Q=async(e,o,a)=>{d.setState({agendamentos:e,agendamentosNaoDisparados:o,sendAfterWhatsAppOpens:a}),await g("agendamentos",e),await g("agendamentosNaoDisparados",o),chrome.runtime.sendMessage({action:"agendamentos-backup-update"})},q=(e,o,a)=>{const{agendamentos:s,agendamentosNaoDisparados:n}=d.getState(),i=[...s],c=[...n];e.forEach(r=>{const m=i.findIndex(f=>f.id===r.id);m===-1?i.push(r):i[m]=r}),o.forEach(r=>{const m=c.findIndex(f=>f.id===r.id);m===-1?c.push(r):c[m]=r}),Q(i,c,a)};export{q as M,Q as R,X as i,d as u};
