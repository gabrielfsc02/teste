import{f as S,i as T,a as y,b as E}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed19.js";import{u as U,i as F,r as C,a as L,b as u,S as A,c as M,d as k,e as R,g as v,f as D,h as I,j as W,k as P,l as $,m as G,n as b,o as O,p as j,q as _,s as N,t as B,I as q}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed22.js";import{u as x}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed23.js";import{E as z,R as J,P as h}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed10.js";import{i as K,a as H}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed24.js";import{i as Q}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed25.js";import{i as V}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed26.js";import{i as X}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed27.js";import{i as Y}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed28.js";import{i as Z}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed29.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed30.js";import{s as tt}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed31.js";import{i as et}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed32.js";import{i as ot}from"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed33.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed6.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed7.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed4.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed18.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed8.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed5.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed2.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed3.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed9.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed34.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed35.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed36.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed37.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed38.js";import"./v_7_3_4_7_6e7deaa1-1876-4289-adc9-5c3b896aa7ed39.js";const at=()=>{const t=document.createElement("script");t.src=chrome.runtime.getURL("whatsapp/index.iife.js"),(document.head||document.documentElement).appendChild(t),t.onload=function(){t.remove()}},st=(t,o,r=5e3)=>{const n=Date.now(),p=()=>{document.querySelector(t)?o():Date.now()-n>=r?(console.error(`Erro: O seletor "${t}" não foi encontrado dentro do tempo limite.`),o()):setTimeout(p,300)};p()};st("#app .app-wrapper-web",()=>{at()});async function it(t,o){return new Promise((r,n)=>{const p=indexedDB.open(t,1);p.onerror=function(s){console.error("Erro ao abrir o banco de dados."),n("Erro ao abrir o banco de dados.")},p.onupgradeneeded=function(s){s.target.result.createObjectStore(o,{keyPath:"id",autoIncrement:!0})},p.onsuccess=function(s){const c=s.target.result,e=c.transaction([o],"readonly").objectStore(o).getAll();e.onsuccess=function(){r(e.result),c.close()},e.onerror=function(){console.error("Erro ao ler os dados da tabela."),n("Erro ao ler os dados da tabela.")}}})}const rt=async()=>{const t=!location.href.includes("https://web.whatsapp");let o=[];if(t)o=await z({stopPropag:!1,action:"getOrderLabels",waitForResponse:!0});else{const r=await it("useOrderLabels","orderLabels");r[0]&&(o=r[0])}x.setState({orderLabels:o})},nt=async()=>{const t=await J("crm");U.setState({crm:t})};rt();nt();(async()=>(await S(),await F(),T(),C.getState().getNotificaoes()))();function ct(t,o){const r=[],n=[],p=new Set(o.flatMap(a=>a.chats.map(e=>`${e.id}|${a.id}`))),s=new Set(t.flatMap(a=>a.chats.map(e=>`${e.id}|${a.id}`))),c=new Map(o.flatMap(a=>a.chats.map(e=>[`${e.id}|${a.id}`,{chat:e,tabId:a.id}]))),m=new Map(t.flatMap(a=>a.chats.map(e=>[`${e.id}|${a.id}`,{chat:e,tabId:a.id}])));for(const a of s)if(!p.has(a)){const e=m.get(a);e&&r.push({...e,chat:{...e.chat,id:h(e.chat.id)}})}for(const a of p)if(!s.has(a)){const e=c.get(a);e&&n.push({...e,chat:{...e.chat,id:h(e.chat.id)}})}return{chatsAdded:r,chatsRemoved:n}}async function g(t,o,r){for(const{chat:n,tabId:p}of t){const s=o.filter(c=>{var i,d,l;const m=c.funil.abas.some(f=>f.id===p),a=n.id.endsWith("@g.us"),e=((l=(d=(i=c.regras)==null?void 0:i.responderGrupos)==null?void 0:d.propriedades)==null?void 0:l.active)!==!1;return m&&c.acionamento.type===r&&(!a||e)});for(const c of s)try{await A(n.id,c)}catch(m){console.error(`❌ Erro ao disparar follow-up: ${c.id} para chat: ${n.id}`,m)}}}function dt(t,o){t.forEach(({chat:r,tabId:n})=>{o.filter(s=>{var e,i,d;const c=s.funil.abas.some(l=>l.id===n),m=r.id.endsWith("@g.us"),a=((d=(i=(e=s.regras)==null?void 0:e.responderGrupos)==null?void 0:i.propriedades)==null?void 0:d.active)!==!1;return c&&s.acionamento.type==="timing"&&(!m||a)}).forEach(s=>{u.getState().addChatToFollowUp(s.id,n,r,"tab")})})}function pt(t,o){t.forEach(({chat:r,tabId:n})=>{o.filter(s=>{var e,i,d;const c=s.funil.abas.some(l=>l.id===n),m=r.id.endsWith("@g.us"),a=((d=(i=(e=s.regras)==null?void 0:e.responderGrupos)==null?void 0:i.propriedades)==null?void 0:d.active)!==!1;return c&&s.acionamento.type==="timing"&&(!m||a)}).forEach(s=>{u.getState().removeChatFromFollowUp(s.id,n,r.id,"tab")})})}function lt(){L.subscribe(async(t,o)=>{if(!t.userTabs||!u.getState().initSubscribeUserTabs)return;const r=t.userTabs||[],n=o.userTabs||[],p=u.getState().FollowUp.filter(i=>i.active);if(p.length===0)return;const s=n.filter(i=>!r.some(d=>d.id===i.id)),{chatsAdded:c,chatsRemoved:m}=ct(r,n),a=s.flatMap(i=>i.chats.map(d=>({chat:d,tabId:i.id}))),e=m.filter(i=>!a.some(d=>d.chat.id===i.chat.id));if(c.length>0){const i=p.filter(l=>l.acionamento.type==="dispararAoEntrar"),d=p.filter(l=>l.acionamento.type==="timing");i.length>0&&await g(c,i,"dispararAoEntrar"),d.length>0&&dt(c,d)}if(e.length>0){const i=p.filter(f=>f.acionamento.type==="dispararAoSair"),d=e.filter(f=>!s.some(w=>w.id===f.tabId));i.length>0&&d.length>0&&await g(d,i,"dispararAoSair");const l=p.filter(f=>f.acionamento.type==="timing");l.length>0&&pt(e,l)}})}window.addEventListener("message",t=>{if(t.data.type==="Ev"&&t.data.action==="chat.update_label"){const o=JSON.parse(t.data.model);o.chat.id={server:"@"+o.chat.id.split("@")[1],user:o.chat.id.split("@")[0],_serialized:o.chat.id},M.getState().dispartWebhook(o.chat.id.user,"labels",{labels:o.labels,type:o.type})}t.data.type==="Ev"&&t.data.action==="chat.presence_change"&&JSON.parse(t.data.model)});k();R();K();H();v();D();Q();V();I();X();W();P();Y();Z();$();lt();tt({useUserLogin:G,useModal:b,useModalOptions:O});y.subscribe(({label:t})=>{t.chromeStoreID==="ahiieliljkcgmghicbgidblclkbklmka"||t.chromeStoreID==="likkccegmkoonimkjnmgpadngedknpdk"||chrome.storage.local.get(["initSystem","userTabs","guardaMsg"],o=>{if(!o.initSystem&&o.userTabs.length===0&&o.guardaMsg.length===0){const{openRendertype:r}=b.getState();r("Modelo_Selecao",!1)}})});window.addEventListener("message",async t=>{t.data.type==="Ev"&&t.data.action==="webpack.full_ready"&&(j(),_(),await E(),et(),await N(),B(),ot(),q())});
